name: CI/CD Pipeline with Quality Gates

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '18'

jobs:
  # ============================================
  # JOB 1: Quality Gates (Tests, Lint, TypeCheck)
  # ============================================
  quality-gates:
    name: ðŸ” Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      # ---- Backend Quality Gates ----
      - name: ðŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: npm ci

      - name: ðŸ” Backend Lint
        working-directory: ./backend
        run: npm run lint || echo "âš ï¸ Linting issues detected"
        continue-on-error: true

      - name: ðŸ§ª Backend Tests
        working-directory: ./backend
        run: npm test -- --coverage --passWithNoTests
        env:
          NODE_ENV: test
          DB_NAME: actionculture_test
          DB_USER: root
          DB_PASSWORD: root
          DB_HOST: localhost
          JWT_SECRET: test-secret-key-for-ci-minimum-32-chars

      - name: ðŸ”’ Backend Security Audit
        working-directory: ./backend
        run: npm audit --audit-level=high || echo "âš ï¸ Security vulnerabilities found"
        continue-on-error: true

      # ---- Frontend Quality Gates ----
      - name: ðŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ðŸ” Frontend Lint
        working-directory: ./frontend
        run: npm run lint || echo "âš ï¸ Linting issues detected"
        continue-on-error: true

      - name: ðŸ“ TypeScript Check
        working-directory: ./frontend
        run: npx tsc --noEmit
        continue-on-error: true

      - name: ðŸ—ï¸ Frontend Build Test
        working-directory: ./frontend
        run: npm run build
        env:
          CI: true

      - name: ðŸ”’ Frontend Security Audit
        working-directory: ./frontend
        run: npm audit --audit-level=high || echo "âš ï¸ Security vulnerabilities found"
        continue-on-error: true

      # ---- Upload Artifacts ----
      - name: ðŸ“Š Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: backend/coverage/
          retention-days: 7

  # ============================================
  # JOB 2: Deploy (only on main branch push)
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: quality-gates
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 82.25.119.112 >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to Server
        run: |
          ssh -o StrictHostKeyChecking=no root@82.25.119.112 << 'EOF'
            echo "ðŸ“¦ Pulling latest changes..."
            cd /home/EventCulture
            git pull origin main

            echo "ðŸ“¦ Installing backend dependencies..."
            cd backend
            npm ci --production

            echo "ðŸ”„ Running database migrations..."
            npx sequelize-cli db:migrate || echo "âš ï¸ No new migrations"

            echo "ðŸ“¦ Installing frontend dependencies..."
            cd ../frontend
            npm ci

            echo "ðŸ—ï¸ Building frontend..."
            npm run build

            echo "ðŸ”„ Restarting services..."
            pm2 restart redis-dev || pm2 start redis-dev
            pm2 restart back-eventculture || pm2 start back-eventculture

            echo "âœ… Deployment complete!"
            pm2 status
          EOF

      - name: ðŸ“¢ Notify Success
        if: success()
        run: echo "âœ… Deployment to production successful!"

      - name: ðŸ“¢ Notify Failure
        if: failure()
        run: echo "âŒ Deployment failed!"

  # ============================================
  # JOB 3: Deploy to Staging (on develop branch)
  # ============================================
  deploy-staging:
    name: ðŸ§ª Deploy to Staging
    runs-on: ubuntu-latest
    needs: quality-gates
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_B64 }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 82.25.119.112 >> ~/.ssh/known_hosts

      - name: ðŸ§ª Deploy to Staging
        run: |
          ssh -o StrictHostKeyChecking=no root@82.25.119.112 << 'EOF'
            echo "ðŸ“¦ Deploying to staging..."
            cd /home/EventCulture-staging || cd /home/EventCulture
            git fetch origin develop
            git checkout develop
            git pull origin develop

            cd backend && npm ci
            cd ../frontend && npm ci && npm run build

            pm2 restart staging-backend || echo "Staging not configured as PM2 process"
            echo "âœ… Staging deployment complete!"
          EOF
